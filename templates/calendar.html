<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å: –º–µ—Å—è—Ü/–¥–µ–Ω—å + –∑–∞–¥–∞—á–∏ –∏ –≤—Å—Ç—Ä–µ—á–∏ (HTML)</title>
  <style>
    :root{ --bg:#fff; --ink:#111; --muted:#6b7280; --line:#e5e7eb; --chip:#f3f4f6; --accent:#111; --accent-ink:#fff; --bad:#b00020; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:22px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .btn{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:999px;cursor:pointer}
    .btn.primary{background:var(--accent);color:var(--accent-ink)}
    .btn.ghost{background:transparent}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .muted{color:var(--muted)}
    .error{background:#ffe8ec;border:1px solid #ffd1d9;color:#7a0017;padding:8px 10px;border-radius:10px}

    /* —Ç–∞–±–ª–∏—Ü—ã */
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
    thead th{background:#fafafa}
    .cell-dim{background:#fafafa;color:#9ca3af}
    .cell-head{display:flex;justify-content:space-between;align-items:center;font-weight:600}
    .pill{display:inline-block;background:var(--chip);padding:2px 6px;border-radius:8px;font-size:12px}
    .list{margin-top:6px;display:flex;flex-direction:column;gap:2px}
    .truncate{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* —Ñ–æ—Ä–º—ã */
    .grid{display:grid;gap:8px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width: 640px){.grid-2{grid-template-columns:1fr}}
    label{font-size:12px;color:#374151}
    input,textarea{width:100%;box-sizing:border-box;padding:8px;border:1px solid var(--line);border-radius:10px;font:inherit}
  </style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h1>
      <span class="muted">–º–µ—Å—è—á–Ω—ã–π/–¥–Ω–µ–≤–Ω–æ–π –≤–∏–¥ –∏ –±—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</span>
      <div class="spacer"></div>
      <button id="btnMonth" class="btn">–ú–µ—Å—è—Ü</button>
      <button id="btnDay" class="btn">–î–µ–Ω—å</button>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º + –≤—ã—Ö–æ–¥ -->
    <div class="row" style="margin:8px 0 12px">
      <button id="prevDay" class="btn" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å">‚Üê</button>
      <div id="currentDate" style="font-weight:600"></div>
      <button id="nextDay" class="btn" title="–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å">‚Üí</button>
      <button id="today" class="btn">–°–µ–≥–æ–¥–Ω—è</button>
      <div class="spacer"></div>
      <button id="logout" class="btn ghost" title="–í—ã–π—Ç–∏" style="display:none">–í—ã–π—Ç–∏</button>
      <div id="status" class="muted"></div>
    </div>

    <div id="err" class="error" style="display:none"></div>

    <!-- –õ–æ–≥–∏–Ω -->
    <div id="loginCard" class="card" style="margin-bottom:12px; display:none">
      <div style="font-weight:600; margin-bottom:8px">–í—Ö–æ–¥</div>
      <div class="grid">
        <div class="grid grid-2">
          <div>
            <label>Email</label>
            <input id="loginEmail" placeholder="you@example.com" />
          </div>
          <div>
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
        </div>
        <div class="row">
          <button id="btnLogin" class="btn primary">–í–æ–π—Ç–∏</button>
        </div>
      </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ —Ñ–æ—Ä–º—ã -->
    <div class="row" style="margin-bottom:12px">
      <div class="card" style="flex:1; min-width:280px">
        <div style="font-weight:600; margin-bottom:8px">–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É (–Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É)</div>
        <div class="grid">
          <div>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input id="taskName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç" />
          </div>
          <div>
            <label>–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input id="taskDesc" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏" />
          </div>
          <div>
            <button id="addTask" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
          </div>
        </div>
      </div>

      <div class="card" style="flex:1; min-width:280px">
        <div style="font-weight:600; margin-bottom:8px">–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É</div>
        <div class="grid">
          <div>
            <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input id="meetTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ç–∞—Ç—É—Å —Å –∫–æ–º–∞–Ω–¥–æ–π" />
          </div>
          <div class="grid grid-2">
            <div>
              <label>–ù–∞—á–∞–ª–æ (–¥–∞—Ç–∞)</label>
              <input id="meetStartDate" type="date" />
            </div>
            <div>
              <label>–ù–∞—á–∞–ª–æ (–≤—Ä–µ–º—è)</label>
              <input id="meetStartTime" type="time" />
            </div>
          </div>
          <div class="grid grid-2">
            <div>
              <label>–ö–æ–Ω–µ—Ü (–¥–∞—Ç–∞)</label>
              <input id="meetEndDate" type="date" />
            </div>
            <div>
              <label>–ö–æ–Ω–µ—Ü (–≤—Ä–µ–º—è)</label>
              <input id="meetEndTime" type="time" />
            </div>
          </div>
          <div>
            <button id="addMeeting" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É</button>
          </div>
        </div>
      </div>
    </div>
    <div style="margin-top: 12px; font-size: 14px; text-align: center;">
      –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="/register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
    </div>

    <!-- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è -->
    <div id="monthView" class="card" style="display:block"></div>
    <div id="dayView" class="card" style="display:none"></div>
  </div>

  <script>
    /***********************
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–æ–¥ —Å–µ–±—è)
     ***********************/
    const CONFIG = {
      baseUrl: "http://127.0.0.1:8000/api/v1",
      loginEndpoint: "/auth/login",
      meEndpoint: "/my-users/me-team",
      userInfoEndpoint: "/users/me",
      tokenStorageKey: "calendar_token",
      teamIdStorageKey: "calendar_team_id"
    };

    /*********************** –£—Ç–∏–ª–∏—Ç—ã ***********************/
    const $ = (s) => document.querySelector(s);
    const pad = (n) => String(n).padStart(2, '0');
    function toYMD(d){ return `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`; }
    function ymdToDate(ymd){ const [y,m,dd]=ymd.split('-').map(Number); return new Date(Date.UTC(y,m-1,dd)); }
    function startOfMonth(d){ return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1)); }
    function addDays(d,n){ const x=new Date(d); x.setUTCDate(x.getUTCDate()+n); return x; }
    function mkISO(dateYMD, timeHM){ const hh=timeHM?.slice(0,2)||'00', mm=timeHM?.slice(3,5)||'00'; return `${dateYMD}T${hh}:${mm}:00`; }
    function formatHuman(d){ return new Intl.DateTimeFormat('ru-RU',{year:'numeric',month:'long',day:'2-digit'}).format(d); }
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }

    /*********************** API ***********************/
    function authHeaders(){ const t=state.authToken||localStorage.getItem(CONFIG.tokenStorageKey)||""; const h={'Content-Type':'application/json'}; if(t) h['Authorization']=`Bearer ${t}`; return h; }
    function urlTasksList(){ return `${CONFIG.baseUrl}/teams/${state.teamId}/tasks`; }
    function urlTasksPost(){ return `${CONFIG.baseUrl}/teams/${state.teamId}/tasks/`; }
    function urlMeetingsTeam(){ return `${CONFIG.baseUrl}/meetings/my`; }
    function urlMeetingsPost(){ return `${CONFIG.baseUrl}/meetings`; }

    async function apiGet(url){ const r=await fetch(url,{headers:authHeaders()}); if(!r.ok) throw new Error(`GET ${url} ‚Üí ${r.status}`); return r.json(); }
    async function apiPost(url, body){ const r=await fetch(url,{method:'POST',headers:authHeaders(),body:JSON.stringify(body)}); if(!r.ok){const t=await r.text(); throw new Error(`POST ${url} ‚Üí ${r.status}: ${t}`);} return r.json(); }

    /*********************** –°–æ—Å—Ç–æ—è–Ω–∏–µ ***********************/
    const state = {
      view:'month',
      selectedDate:(()=>{const n=new Date();return new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()));})(),
      tasks:[], meetings:[], authToken:null, teamId:null
    };

    /*********************** –ó–∞–≥—Ä—É–∑–∫–∞ ***********************/
    async function loadAll(){
      if(!state.authToken){ 
        renderAuthNeeded(); 
        return; 
      }
      
      // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ó–∞–≥—Ä—É–∑–∫–∞..."
      if (state.teamId) {
        setStatus('–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶');
      }
      hideError();
      
      try{
        let tasks = [];
        let meetings = [];
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—Ç—Ä–µ—á–∏ –¥–ª—è –≤—Å–µ—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        try {
          meetings = await apiGet(urlMeetingsTeam()) || [];
        } catch(e) {
          console.log('No access to meetings:', e);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å teamId (–Ω–µ –¥–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
        if(state.teamId){
          try {
            tasks = await apiGet(urlTasksList()) || [];
          } catch(e) {
            console.log('No access to tasks:', e);
          }
        }
        
        state.tasks = tasks || []; 
        state.meetings = meetings || [];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if(state.teamId) {
          setStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: –∑–∞–¥–∞—á ${state.tasks.length}, –≤—Å—Ç—Ä–µ—á ${state.meetings.length}`);
        }
        // –î–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–µ—Ç—Å—è "–ê–≤–µ, –¶–µ–∑–∞—Ä—å..."
        
      } catch(e){ 
        showError(String(e.message||e)); 
        if(state.teamId) {
          setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        } else {
          setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
      }
      
      renderViews();
    }

    /*********************** –†–µ–Ω–¥–µ—Ä: –º–µ—Å—è—Ü/–¥–µ–Ω—å ***********************/
    function buildMonthMatrix(current){
      const first = startOfMonth(current);
      const firstWeekday = (first.getUTCDay()+6)%7; // –ø–Ω=0
      const firstCell = addDays(first, -firstWeekday);
      const rows=[]; for(let w=0;w<6;w++){ const row=[]; for(let d=0;d<7;d++) row.push(addDays(firstCell,w*7+d)); rows.push(row);} return rows;
    }
    function renderMonth(){
      const cont = $('#monthView'); const m = state.selectedDate.getUTCMonth(); const rows = buildMonthMatrix(state.selectedDate);
      const weekHdr = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].map(h=>`<th>${h}</th>`).join('');
      let html = `<table><thead><tr>${weekHdr}</tr></thead><tbody>`;
      for(const row of rows){ html += '<tr>'; for(const date of row){ const ymd=toYMD(date); const dim = (date.getUTCMonth()!==m)?'cell-dim':''; const dayTasks=state.tasks.filter(t=>(t.deadline_at||'').startsWith(ymd)); const dayMeets=state.meetings.filter(mm=>(mm.starts_at||'').startsWith(ymd)||(mm.ends_at||'').startsWith(ymd)); const count=dayTasks.length+dayMeets.length; const items=[...dayTasks.slice(0,3).map(t=>`<div class="truncate">üóíÔ∏è ${escapeHtml(t.name||'')}</div>`), ...dayMeets.slice(0,3).map(mm=>`<div class="truncate">üìÖ ${escapeHtml(mm.title||'')}</div>`)].join(''); const more=count>3?`<div class="muted" style="font-size:12px">–µ—â—ë ${count-3}‚Ä¶</div>`:''; html += `<td class="${dim}" data-ymd="${ymd}"><div class="cell-head"><span>${date.getUTCDate()}</span><span class="pill">${count}</span></div><div class="list">${items}${more}</div></td>`; } html += '</tr>'; }
      html += '</tbody></table>';
      cont.innerHTML = html;
      cont.querySelectorAll('td[data-ymd]').forEach(td=> td.addEventListener('click',()=>{ state.selectedDate = ymdToDate(td.getAttribute('data-ymd')); setView('day'); renderViews(); }));
    }
    function renderDay(){
      const cont=$('#dayView'); const ymd=toYMD(state.selectedDate);
      const meetings = state.meetings.filter(m=>(m.starts_at||'').startsWith(ymd)||(m.ends_at||'').startsWith(ymd)).sort((a,b)=>String(a.starts_at).localeCompare(String(b.starts_at)));
      const tasks = state.tasks.filter(t=>(t.deadline_at||'').startsWith(ymd));
      let html = `<table><thead><tr><th style="width:120px">–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th style="width:160px">–í—Ä–µ–º—è / –î–µ–¥–ª–∞–π–Ω</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th></tr></thead><tbody>`;
      for(const m of meetings){ html += `<tr><td>${ymd}</td><td>–í—Å—Ç—Ä–µ—á–∞</td><td>${(m.starts_at||'').slice(11,16)}‚Äì${(m.ends_at||'').slice(11,16)}</td><td><b>${escapeHtml(m.title||'')}</b></td><td class="muted">${escapeHtml(m.description||'‚Äî')}</td></tr>`; }
      for(const t of tasks){ html += `<tr><td>${ymd}</td><td>–ó–∞–¥–∞—á–∞</td><td>–¥–µ–¥–ª–∞–π–Ω ${((t.deadline_at||'').slice(11,16))||'‚Äî'}</td><td><b>${escapeHtml(t.name||'')}</b></td><td class="muted">${escapeHtml(t.description||'‚Äî')}</td></tr>`; }
      if(meetings.length===0 && tasks.length===0){ html += `<tr><td colspan="5" class="muted" style="text-align:center; padding:18px">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–∏—á–µ–≥–æ –Ω–µ—Ç</td></tr>`; }
      html += '</tbody></table>';
      cont.innerHTML = html;
    }

    function renderViews(){ $('#currentDate').textContent = formatHuman(state.selectedDate); if(state.view==='month') { $('#monthView').style.display='block'; $('#dayView').style.display='none'; renderMonth(); } else { $('#monthView').style.display='none'; $('#dayView').style.display='block'; renderDay(); } }

    /*********************** –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ***********************/
    function setStatus(t){ $('#status').textContent=t||''; }
    function showError(t){ const el=$('#err'); el.textContent=t; el.style.display='block'; }
    function hideError(){ $('#err').style.display='none'; }
    function renderAuthNeeded(){ 
      $('#loginCard').style.display='block';
      $('#monthView').style.display='none';
      $('#dayView').style.display='none';
      $('#logout').style.display='none';
    }

    async function doLogin(){
      hideError();
      const email=$('#loginEmail').value.trim(); const password=$('#loginPassword').value.trim();
      if(!email||!password){ showError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –Ω–∏–∂–µ'); return; }
      try{
        const url = CONFIG.baseUrl + CONFIG.loginEndpoint;
        // –°–µ—Ä–≤–µ—Ä –æ–∂–∏–¥–∞–µ—Ç OAuth2PasswordRequestForm: application/x-www-form-urlencoded —Å –ø–æ–ª—è–º–∏ username, password
        const body = new URLSearchParams({ username: email, password });
        const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body });
        if(!res.ok){ const t=await res.text(); throw new Error(`–í—Ö–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è: ${res.status} ${t}`); }
        const data = await res.json();
        const token = data.token || data.access_token || data.accessToken;
        if(!token) throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–æ–∫–µ–Ω');
        await setAuthAndMaybeTeam(token, data.team_id || data.teamId);
      }catch(e){ showError(String(e.message||e)); }
    }

    async function setAuthAndMaybeTeam(token, teamId){
      state.authToken = token; 
      localStorage.setItem(CONFIG.tokenStorageKey, token);
      
      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
      let userInfo;
      try{ 
        userInfo = await apiGet(CONFIG.baseUrl + CONFIG.meEndpoint);
        teamId = userInfo.team_id || userInfo.teamId;
        
        // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥–∞ - –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Ö–æ–¥
        if (teamId) {
          state.teamId = Number(teamId); 
          localStorage.setItem(CONFIG.teamIdStorageKey, String(state.teamId));
          $('#loginCard').style.display = 'none';
          $('#logout').style.display = 'inline-block';
          setStatus(''); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å
          await loadAll();
          return;
        }
        
        // –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥—ã –Ω–µ—Ç - –ø—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        try {
          const fullUserInfo = await apiGet(CONFIG.baseUrl + CONFIG.userInfoEndpoint);
          if (fullUserInfo.is_superuser) {
            // –°–£–ü–ï–†–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ - —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Ö–æ–¥
            state.teamId = null; 
            localStorage.setItem(CONFIG.teamIdStorageKey, 'superuser'); // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            $('#loginCard').style.display = 'none';
            $('#logout').style.display = 'inline-block';
            setStatus('–ê–≤–µ, –¶–µ–∑–∞—Ä—å, –∏–¥—É—â–∏–µ –Ω–∞ —Å–º–µ—Ä—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç–µ–±—è');
            await loadAll();
            return;
          } else {
            // –û–ë–´–ß–ù–´–ô –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã - –ó–ê–ü–†–ï–©–ê–ï–ú –≤—Ö–æ–¥
            showError('–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –∫–æ–º–∞–Ω–¥—É.');
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
            state.authToken = null;
            localStorage.removeItem(CONFIG.tokenStorageKey);
            localStorage.removeItem(CONFIG.teamIdStorageKey);
            return;
          }
        } catch (userInfoError) {
          console.error('Cannot check superuser status:', userInfoError);
          // –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –∑–∞–ø—Ä–µ—â–∞–µ–º –≤—Ö–æ–¥
          showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
          state.authToken = null;
          localStorage.removeItem(CONFIG.tokenStorageKey);
          localStorage.removeItem(CONFIG.teamIdStorageKey);
          return;
        }
        
      } catch(e){ 
        console.error('Failed to get user profile:', e);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        state.authToken = null;
        localStorage.removeItem(CONFIG.tokenStorageKey);
        localStorage.removeItem(CONFIG.teamIdStorageKey);
        return;
      }
    }

    function useProvidedToken(){ hideError(); const t=$('#tokenInput').value.trim(); if(!t){ showError('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω'); return; } setAuthAndMaybeTeam(t, $('#teamIdInput').value.trim()); }
    function logout(){ 
      localStorage.removeItem(CONFIG.tokenStorageKey);
      localStorage.removeItem(CONFIG.teamIdStorageKey);
      state.authToken = null; 
      state.teamId = null; 
      state.tasks = []; 
      state.meetings = [];
      setStatus('');
      $('#logout').style.display = 'none';
      renderAuthNeeded(); 
    }

    /*********************** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ ***********************/
    async function addTask(){
      if(!state.authToken){ 
        showError('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); 
        return; 
      }
      
      // –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞—á–∏
      if(!state.teamId) {
        showError('–°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã');
        return;
      }
      
      const name=$('#taskName').value.trim(); 
      const desc=$('#taskDesc').value.trim(); 
      if(!name){ 
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏'); 
        return; 
      }
      
      const ymd=toYMD(state.selectedDate); 
      const payload={name, description: desc||null, deadline_at:`${ymd}T00:00:00`};
      const temp={id:Math.random()*1e9|0,name,description:desc||null,deadline_at:payload.deadline_at}; 
      state.tasks.unshift(temp); 
      renderViews();
      
      try{ 
        const created=await apiPost(urlTasksPost(), payload); 
        state.tasks=[created,...state.tasks.filter(t=>t!==temp)]; 
        $('#taskName').value=''; 
        $('#taskDesc').value=''; 
      } catch(e){ 
        state.tasks=state.tasks.filter(t=>t!==temp); 
        showError(String(e.message||e)); 
      }
      renderViews();
    }
    async function addMeeting(){
      if(!state.authToken){ 
        showError('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); 
        return; 
      }
      
      // –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á–∏
      if(!state.teamId) {
        showError('–°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á–∏ –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã');
        return;
      }
      
      const title=$('#meetTitle').value.trim(); 
      if(!title){ 
        alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫'); 
        return; 
      }
      
      const ymd=toYMD(state.selectedDate);
      const sDate=$('#meetStartDate').value||ymd; 
      const sTime=$('#meetStartTime').value||'09:00';
      const eDate=$('#meetEndDate').value||ymd; 
      const eTime=$('#meetEndTime').value||'10:00';
      
      const payload={title,description:null,starts_at:mkISO(sDate,sTime),ends_at:mkISO(eDate,eTime)};
      const temp={id:Math.random()*1e9|0,title,description:null,starts_at:payload.starts_at,ends_at:payload.ends_at}; 
      state.meetings.unshift(temp); 
      renderViews();
      
      try{ 
        const created=await apiPost(urlMeetingsPost(), payload); 
        state.meetings=[created,...state.meetings.filter(m=>m!==temp)]; 
        $('#meetTitle').value=''; 
        $('#meetStartDate').value=''; 
        $('#meetStartTime').value=''; 
        $('#meetEndDate').value=''; 
        $('#meetEndTime').value=''; 
      } catch(e){ 
        state.meetings=state.meetings.filter(m=>m!==temp); 
        showError(String(e.message||e)); 
      }
      renderViews();
    }

    /*********************** –ù–∞–≤–∏–≥–∞—Ü–∏—è/—Å—Ç–∞—Ä—Ç ***********************/
    function setView(v){ state.view=v; $('#btnMonth').classList.toggle('primary', v==='month'); $('#btnDay').classList.toggle('primary', v==='day'); }

    $('#btnMonth').addEventListener('click', ()=>{ setView('month'); renderViews(); });
    $('#btnDay').addEventListener('click', ()=>{ setView('day'); renderViews(); });
    $('#prevDay').addEventListener('click', ()=>{ state.selectedDate=addDays(state.selectedDate,-1); renderViews(); });
    $('#nextDay').addEventListener('click', ()=>{ state.selectedDate=addDays(state.selectedDate,1); renderViews(); });
    $('#today').addEventListener('click', ()=>{ const n=new Date(); state.selectedDate=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate())); renderViews(); });

    $('#addTask').addEventListener('click', addTask);
    $('#addMeeting').addEventListener('click', addMeeting);
    $('#btnLogin').addEventListener('click', doLogin);
    $('#logout').addEventListener('click', logout);

    (function start(){
      setView('month');
      const savedToken = localStorage.getItem(CONFIG.tokenStorageKey);
      const savedTeamId = localStorage.getItem(CONFIG.teamIdStorageKey);
      
      // –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      state.authToken = null;
      state.teamId = null;
      state.tasks = [];
      state.meetings = [];
      setStatus('');
      
      if(savedToken){ 
        state.authToken = savedToken; 
      }
      
      if(savedTeamId){ 
        if (savedTeamId === 'superuser') {
          state.teamId = null;
          // –î–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –Ω—É–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
          checkSuperuserStatus();
          return;
        } else {
          state.teamId = Number(savedTeamId); 
        }
      }
      
      $('#logout').style.display = state.authToken ? 'inline-block' : 'none';
      
      if(state.authToken && state.teamId){ 
        loadAll(); 
      } else if (state.authToken && !state.teamId) {
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω, –Ω–æ –Ω–µ—Ç teamId - –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–∏ —ç—Ç–æ
        checkSuperuserStatus();
      } else { 
        renderAuthNeeded(); 
      }
      
      $('#currentDate').textContent = formatHuman(state.selectedDate);
    })();
    async function checkSuperuserStatus() {
      try {
        const fullUserInfo = await apiGet(CONFIG.baseUrl + CONFIG.userInfoEndpoint);
        if (fullUserInfo.is_superuser) {
          state.teamId = null;
          $('#loginCard').style.display = 'none';
          $('#logout').style.display = 'inline-block';
          setStatus('–ê–≤–µ, –¶–µ–∑–∞—Ä—å, –∏–¥—É—â–∏–µ –Ω–∞ —Å–º–µ—Ä—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç–µ–±—è');
          await loadAll();
        } else {
          // –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã - —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ–º
          showError('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
          logout();
        }
      } catch (e) {
        console.error('Failed to check superuser status:', e);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞');
        logout();
      }
    }
  </script>
</body>
</html>
